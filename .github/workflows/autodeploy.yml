name: autodeploy

on:
    push:
        branches: [ 'main' ]

jobs:
    autodeploy:
        runs-on: ubuntu-latest
        permissions:
            packages: write
        env:
            FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
            REGISTRY: ghcr.io
            IMAGE_NAME: ${{ github.repository }}
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        steps:
            -   uses: actions/checkout@v3

            -   uses: graalvm/setup-graalvm@v1
                with:
                    version: 'latest'
                    java-version: '17'
                    components: 'native-image'
                    github-token: ${{ secrets.GITHUB_TOKEN }}

            -   name: Setup Gradle
                uses: gradle/gradle-build-action@v2

            -   name: Run build with Gradle Wrapper
                run: ./gradlew bootBuildImage
            -   name: Set Image Tag Version
                run: echo "TAG_VERSION=$( ./gradlew properties -q | grep "^version:" | awk '{print $2}')" >> $GITHUB_ENV

            -   name: Tag Image
                run: docker tag ghcr.io/kris456/mealweek-backend:latest ghcr.io/kris456/mealweek-backend:${{ env.TAG_VERSION }}

            -   name: Login to Github Registry
                run: echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u USERNAME --password-stdin

            -   name: Push Image to DockerHub
                run: docker push ghcr.io/kris456/mealweek-backend:latest && docker push ghcr.io/kris456/mealweek-backend:${{ env.TAG_VERSION }}

            -   name: Install flyctl via https://github.com/superfly/flyctl-actions
                uses: superfly/flyctl-actions/setup-flyctl@master

            -   name: Deploy to fly.io
                run: flyctl deploy --image ghcr.io/kris456/mealweek-backend:${{ env.TAG_VERSION }} -t ${{ env.FLY_API_TOKEN }}